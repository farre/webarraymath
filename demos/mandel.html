<html>
<head>
<title>Web Array Math API - Mandelbrot</title>
<script type="text/javascript">
function Demo() {
  // Constants.
  var NUM_WORKERS = 16;

  // Private members.
  var m_canvas;
  var m_ctx;
  var m_width;
  var m_height;
  var m_img;
  var m_workers;
  var m_num_active_workers;

  var m_cplx_center = { x: -0.5, y: 0.0 };
  var m_cplx_height = 2;

  var getBounds = function () {
    var h = m_cplx_height / 2;
    var w = h * (m_width / m_height);
    return {
      xMin: m_cplx_center.x - w,
      xMax: m_cplx_center.x + w,
      yMin: m_cplx_center.y - h,
      yMax: m_cplx_center.y + h
    };
  };

  var m_t_start = -1;

  var animateBounds = function () {
    var t = (new Date()).getTime() * 0.001;
    if (m_t_start < 0) {
      m_t_start = t;
    }
    t -= m_t_start;

    m_cplx_height = 1 + 0.8 * Math.cos(0.2*t);
    m_cplx_center.x = -0.5 + 0.2 * Math.sin(0.3*t);
    m_cplx_center.y = 0.0 + 0.2 * Math.sin(0.45*t);
  };

  var redraw = function () {
    if (m_num_active_workers > 0) {
      return;
    }

    animateBounds();
    var bounds = getBounds();

    var startWorker = function (worker, firstRow, numRows) {
      worker.onmessage = function (e) {
        // Fill the canvas with the result.
        m_img.data.set(e.data.pixels, firstRow * m_width * 4);

        // Last worker?
        m_num_active_workers--;
        if (m_num_active_workers == 0) {
          // Write the image data.
          m_ctx.putImageData(m_img, 0, 0);

          // Request another animation frame.
          if (window.requestAnimationFrame)
            requestAnimationFrame(redraw);
          else if (window.mozRequestAnimationFrame)
            mozRequestAnimationFrame(redraw);
          else if (window.webkitRequestAnimationFrame)
            webkitRequestAnimationFrame(redraw);
          else
            setTimeout(redraw, 1);
        }
      };

      // Start the worker.
      worker.postMessage({
        width: m_width,
        height: numRows,
        reMin: bounds.xMin,
        reMax: bounds.xMax,
        imMin: bounds.yMin + (firstRow / m_height) * (bounds.yMax - bounds.yMin),
        imMax: bounds.yMin + ((firstRow + numRows - 1) / m_height) * (bounds.yMax - bounds.yMin)
      });
    };

    // Start all workers.
    var m_num_active_workers = NUM_WORKERS;
    var t0 = new Date();
    var firstRow = 0, numRows = Math.ceil(m_height / NUM_WORKERS);
    for (var k = 0; k < NUM_WORKERS; ++k) {
      if (firstRow + numRows > m_height) {
        numRows = m_height - firstRow;
      }
      startWorker(m_workers[k], firstRow, numRows);
      firstRow += numRows;
    }
  };

  this.init = function () {
    // Init the canvas.
    m_canvas = document.getElementById("canvas");
    m_ctx = m_canvas.getContext("2d");
    m_width = m_canvas.width;
    m_height = m_canvas.height;
    m_img = m_ctx.createImageData(m_width, m_height);

    // Set up workers.
    m_workers = [];
    for (var k = 0; k < NUM_WORKERS; ++k) {
      // Set up the worker.
      var w = new Worker("mandel.js");
      w.onerror = function (e) {
        alert("ERROR: " + e.filename + "(" + e.lineno + "): " +  e.message);
      }
      m_workers[k] = w;
    }
    m_num_active_workers = 0;

    // Start animation.
    redraw();
  };
};

var demo = new Demo();
</script>
<style type="text/css">
body {
  font-family: sans-serif;
}
</style>
</head>
<body onload="demo.init()">
<h2>Mandelbrot demo</h2>
<div>
<canvas id="canvas" width="1024" height="683" />
</div>
</body>
</html>

