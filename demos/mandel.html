<html>
<head>
<title>Web Array Math API - Mandelbrot</title>
<script type="text/javascript">
function Demo() {
  // Constants.
  var NUM_WORKERS = 8;

  // Private members.
  var m_canvas;
  var m_ctx;
  var m_width;
  var m_height;
  var m_img;
  var m_workers;
  var m_num_active_workers;

  this.init = function () {
    // Init the canvas.
    m_canvas = document.getElementById("canvas");
    m_ctx = m_canvas.getContext("2d");
    m_width = m_canvas.width;
    m_height = m_canvas.height;
    m_img = m_ctx.createImageData(m_width, m_height);

    // Set up workers.
    m_workers = [];
    for (var k = 0; k < NUM_WORKERS; ++k) {
      // Set up the worker.
      var w = new Worker("mandel.js");
      w.onerror = function (e) {
        document.getElementById("output").textContent += "ERROR: " +
            e.filename + "(" + e.lineno + "): " +  e.message + "\n";
      }
      m_workers[k] = w;
    }
    m_num_active_workers = 0;
  };

  this.redraw = function (reMin, reMax, imMin, imMax) {
    if (m_num_active_workers > 0) {
      return;
    }

    var startWorker = function (worker, firstRow, numRows) {
      worker.onmessage = function (e) {
        // Fill the canvas with the result.
        m_img.data.set(e.data.pixels, firstRow * m_width * 4);

        // Last worker?
        m_num_active_workers--;
        if (m_num_active_workers == 0) {
          // Print time spent in the workers.
          var t1 = new Date();
          document.getElementById("output").textContent += "Time: " + ((t1 - t0) * 0.001) + "s\n";

          // Write the image data.
          m_ctx.putImageData(m_img, 0, 0);
        }
      };

      // Start the worker.
      worker.postMessage({
        width: m_width,
        height: numRows,
        reMin: reMin,
        reMax: reMax,
        imMin: imMin + (firstRow / m_height) * (imMax - imMin),
        imMax: imMin + ((firstRow + numRows - 1) / m_height) * (imMax - imMin)
      });
    };

    // Start all workers.
    var m_num_active_workers = NUM_WORKERS;
    var t0 = new Date();
    var firstRow = 0, numRows = Math.ceil(m_height / NUM_WORKERS);
    for (var k = 0; k < NUM_WORKERS; ++k) {
      if (firstRow + numRows > m_height) {
        numRows = m_height - firstRow;
      }
      startWorker(m_workers[k], firstRow, numRows);
      firstRow += numRows;
    }
  };
};

var demo = new Demo();
</script>
<style type="text/css">
body {
  font-family: sans-serif;
}
</style>
</head>
<body onload="demo.init()">
<h2>Mandelbrot demo</h2>
<div>
<input type="submit" value="Redraw" onclick="demo.redraw(-2, 1, -1, 1)" />
</div>
<div>
<canvas id="canvas" width="1024" height="683" />
</div>
<pre id="output"></pre>
</body>
</html>

